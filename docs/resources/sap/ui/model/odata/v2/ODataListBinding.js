/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/assert","sap/base/Log","sap/base/util/deepEqual","sap/base/util/each","sap/base/util/isEmptyObject","sap/base/util/uid","sap/ui/model/ChangeReason","sap/ui/model/Context","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/FilterProcessor","sap/ui/model/FilterType","sap/ui/model/ListBinding","sap/ui/model/Sorter","sap/ui/model/SorterProcessor","sap/ui/model/odata/CountMode","sap/ui/model/odata/Filter","sap/ui/model/odata/ODataUtils","sap/ui/model/odata/OperationMode"],function(t,e,s,i,a,n,r,h,o,l,u,d,f,p,g,c,y,b,m){"use strict";var C=f.extend("sap.ui.model.odata.v2.ODataListBinding",{constructor:function(t,e,s,i,a,n){f.apply(this,arguments);this.sFilterParams=null;this.sSortParams=null;this.sRangeParams=null;this.sCustomParams=this.oModel.createCustomParams(this.mParameters);this.mCustomParams=n&&n.custom;this.iStartIndex=0;this.iLength=0;this.bPendingChange=false;this.aAllKeys=null;this.aKeys=[];this.sCountMode=n&&n.countMode||this.oModel.sDefaultCountMode;this.sOperationMode=n&&n.operationMode||this.oModel.sDefaultOperationMode;this.bCreatePreliminaryContext=n&&n.createPreliminaryContext||t.bPreliminaryContext;this.bUsePreliminaryContext=n&&n.usePreliminaryContext||t.bPreliminaryContext;this.bRefresh=false;this.bNeedsUpdate=false;this.bDataAvailable=false;this.bIgnoreSuspend=false;this.bPendingRefresh=false;this.sGroupId=undefined;this.sRefreshGroupId=undefined;this.bLengthRequested=false;this.bUseExtendedChangeDetection=true;this.bFaultTolerant=n&&n.faultTolerant;this.bLengthFinal=false;this.iLastEndIndex=0;this.aLastContexts=null;this.aLastContextData=null;this.bInitial=true;this.mRequestHandles={};this.oCountHandle=null;this.bSkipDataEvents=false;this.bUseExpandedList=false;this.oCombinedFilter=null;this.sDeepPath=t.resolveDeep(e,s);this.bCanonicalRequest=n&&n.bCanonicalRequest;this.mNormalizeCache={};this.bTransitionMessagesOnly=!!(n&&n.transitionMessagesOnly);this.oModel.checkFilterOperation(this.aApplicationFilters);if(n&&(n.batchGroupId||n.groupId)){this.sGroupId=n.groupId||n.batchGroupId}this.iThreshold=n&&n.threshold||0;this.bThresholdRejected=false;if(this.sCountMode==c.None){this.bThresholdRejected=true}var r=this.checkExpandedList();if(!r){this.resetData()}},metadata:{publicMethods:["getLength"]}});C.prototype.getContexts=function(t,e,s){var i,a,n,r,h=[];if(this.bInitial){return[]}if(!this.bLengthFinal&&this.sOperationMode==m.Auto&&(this.sCountMode==c.Request||this.sCountMode==c.Both)){if(!this.bLengthRequested){this._getLength();this.bLengthRequested=true}return[]}if(!this.bLengthFinal&&!this.bPendingRequest&&!this.bLengthRequested){this._getLength();this.bLengthRequested=true}this.iLastLength=e;this.iLastStartIndex=t;this.iLastThreshold=s;if(!t){t=0}if(!e){e=this.oModel.iSizeLimit;if(this.bLengthFinal&&this.iLength<e){e=this.iLength}}if(!s){s=0}if(this.sOperationMode==m.Auto){if(this.iThreshold>=0){s=Math.max(this.iThreshold,s)}}i=this._getContexts(t,e);if(this.useClientMode()){if(!this.aAllKeys&&!this.bPendingRequest&&this.oModel.getServiceMetadata()){this.loadData();i.dataRequested=true}}else{r=this.bLengthFinal?this.iLength:undefined;n=b._getReadIntervals(this.aKeys,t,e,s,r);a=b._mergeIntervals(n);if(this.oModel.getServiceMetadata()){if(!this.bPendingRequest&&a){this.loadData(a.start,a.end-a.start);i.dataRequested=true}}}if(this.bRefresh){this.bRefresh=false}else{for(var o=0;o<i.length;o++){h.push(this.getContextData(i[o]))}if(this.bUseExtendedChangeDetection){if(this.aLastContexts&&t<this.iLastEndIndex){i.diff=this.diffData(this.aLastContextData,h)}}this.iLastEndIndex=t+e;this.aLastContexts=i.slice(0);this.aLastContextData=h.slice(0)}return i};C.prototype.getCurrentContexts=function(){return this.aLastContexts||[]};C.prototype.getEntryKey=function(t){return t.getPath()};C.prototype.getEntryData=function(t){return JSON.stringify(t.getObject(this.mParameters))};C.prototype._getContexts=function(t,e){var s,i,a=[],n=this.oModel.resolveDeep(this.sPath,this.oContext);if(!t){t=0}if(!e){e=this.oModel.iSizeLimit;if(this.bLengthFinal&&this.iLength<e){e=this.iLength}}for(var r=t;r<t+e;r++){i=this.aKeys[r];if(!i){break}s=this.oModel.getContext("/"+i,n+i.substr(i.indexOf("(")));a.push(s)}return a};C.prototype.setContext=function(t){var s,i=t&&t.isRefreshForced(),a=t&&t.isPreliminary(),n=t&&t.isTransient&&t.isTransient(),o=t&&t.isUpdated();if(this.bInitial||!this.isRelative()){return}if(a&&!this.bUsePreliminaryContext){return}if(o&&this.bUsePreliminaryContext&&this.oContext===t){this._fireChange({reason:r.Context});return}if(h.hasChanged(this.oContext,t)){this.oContext=t;s=this.getResolvedPath();this.sDeepPath=this.oModel.resolveDeep(this.sPath,this.oContext);if(!this._checkPathType()){e.error("List Binding is not bound against a list for "+s)}this.checkDataState();if(!s||n){if(this.aAllKeys||this.aKeys.length>0||this.iLength>0){this.aAllKeys=null;this.aKeys=[];this.iLength=0;this.bLengthFinal=true;this._fireChange({reason:r.Context})}return}this._initSortersFilters();if(this.checkExpandedList()&&!i){this.abortPendingRequest();this._fireChange({reason:r.Context})}else{this._refresh()}}};C.prototype.checkExpandedList=function(t){var e=!!this.getResolvedPath(),s=this.oModel._getObject(this.sPath,this.oContext);if(!e||s===undefined||this.mCustomParams||this.sOperationMode===m.Server&&(this.aApplicationFilters.length>0||this.aFilters.length>0||this.aSorters.length>0)){this.bUseExpandedList=false;this.aExpandRefs=undefined;return false}else{this.bUseExpandedList=true;if(Array.isArray(s)){if(!t&&(this.oModel._isReloadNeeded("/"+s[0],this.mParameters)||this.oModel._isReloadNeeded("/"+s[s.length-1],this.mParameters))){this.bUseExpandedList=false;this.aExpandRefs=undefined;return false}this.aExpandRefs=s;this.aAllKeys=s;this.iLength=s.length;this.bLengthFinal=true;this.bDataAvailable=true;this._initSortersFilters();this.applyFilter();this.applySort()}else{this.aExpandRefs=undefined;this.aAllKeys=null;this.aKeys=[];this.iLength=0;this.bLengthFinal=true;this.bDataAvailable=true}return true}};C.prototype.updateExpandedList=function(t){if(this.aExpandRefs){for(var e=0;e<t.length;e++){this.aExpandRefs[e]=t[e]}this.aExpandRefs.length=t.length}};C.prototype.useClientMode=function(){return this.sOperationMode===m.Client||this.sOperationMode===m.Auto&&!this.bThresholdRejected||this.sOperationMode!==m.Server&&this.bUseExpandedList};C.prototype.loadData=function(t,e){var s=this,a=false,h=n(),o;if(t||e){this.sRangeParams="$skip="+t+"&$top="+e;this.iStartIndex=t}else{t=this.iStartIndex}var l=[];if(this.sRangeParams&&!this.useClientMode()){l.push(this.sRangeParams)}if(this.sSortParams){l.push(this.sSortParams)}if(this.sFilterParams&&!this.useClientMode()){l.push(this.sFilterParams)}if(this.sCustomParams){l.push(this.sCustomParams)}if(this.sCountMode==c.InlineRepeat||!this.bLengthFinal&&(this.sCountMode===c.Inline||this.sCountMode===c.Both)){l.push("$inlinecount=allpages");a=true}function u(n){if(a&&n.__count!==undefined){s.iLength=parseInt(n.__count);s.bLengthFinal=true;if(s.sOperationMode==m.Auto){if(s.iLength<=s.mParameters.threshold){s.bThresholdRejected=false}else{s.bThresholdRejected=true;delete s.mRequestHandles[h];s.bPendingRequest=false;s.bNeedsUpdate=true;return}}}if(s.useClientMode()){s.aKeys=[];i(n.results,function(t,e){s.aKeys[t]=s.oModel._getKey(e)});s.updateExpandedList(s.aKeys);s.aAllKeys=s.aKeys.slice();s.iLength=s.aKeys.length;s.bLengthFinal=true;s.applyFilter();s.applySort()}else{if(n.results.length>0){i(n.results,function(e,i){s.aKeys[t+e]=s.oModel._getKey(i)});if(s.iLength<t+n.results.length){s.iLength=t+n.results.length;s.bLengthFinal=false}if(!n.__next&&(n.results.length<e||e===undefined)){s.iLength=t+n.results.length;s.bLengthFinal=true}}else{if(s.bFaultTolerant&&n.__next){s.iLength=t;s.bLengthFinal=true}if(t===0){s.iLength=0;s.aKeys=[];s.bLengthFinal=true}if(t===s.iLength){s.bLengthFinal=true}}}delete s.mRequestHandles[h];s.bPendingRequest=false;s.bNeedsUpdate=true;s.bIgnoreSuspend=true;s.oModel.callAfterUpdate(function(){s.fireDataReceived({data:n})})}function d(t){var e=t.statusCode==0;delete s.mRequestHandles[h];s.bPendingRequest=false;if(s.bFaultTolerant){s.iLength=s.aKeys.length;s.bLengthFinal=true;s.bDataAvailable=true}else if(!e){s.aKeys=[];s.aAllKeys=[];s.iLength=0;s.bLengthFinal=true;s.bDataAvailable=true;s._fireChange({reason:r.Change})}if(!s.bSkipDataEvents){s.fireDataReceived()}}var f=this.sPath;if(this.isRelative()){f=this.getResolvedPath()}if(f){this.bPendingRequest=true;if(!this.bSkipDataEvents){this.fireDataRequested()}this.bSkipDataEvents=false;o=this.sRefreshGroupId?this.sRefreshGroupId:this.sGroupId;this.mRequestHandles[h]=this.oModel.read(this.sPath,{headers:this.bTransitionMessagesOnly?{"sap-messages":"transientOnly"}:undefined,context:this.oContext,groupId:o,urlParameters:l,success:u,error:d,canonicalRequest:this.bCanonicalRequest,updateAggregatedMessages:this.bRefresh})}};C.prototype.isLengthFinal=function(){return this.bLengthFinal};C.prototype.getLength=function(){if(this.bLengthFinal||this.iLength==0){return this.iLength}else{var t=this.iLastThreshold||this.iLastLength||10;return this.iLength+t}};C.prototype._getLength=function(){var t=this;var s;if(this.sCountMode!==c.Request&&this.sCountMode!==c.Both){return}var a=[];if(this.sFilterParams&&this.sOperationMode!=m.Auto){a.push(this.sFilterParams)}if(this.mParameters&&this.mParameters.custom){var n={custom:{}};i(this.mParameters.custom,function(t,e){n.custom[t]=e});a.push(this.oModel.createCustomParams(n))}function h(e){t.iLength=parseInt(e);t.bLengthFinal=true;t.bLengthRequested=true;t.oCountHandle=null;if(t.sOperationMode==m.Auto){if(t.iLength<=t.mParameters.threshold){t.bThresholdRejected=false}else{t.bThresholdRejected=true}t._fireChange({reason:r.Change})}}function o(s){delete t.mRequestHandles[l];var i="Request for $count failed: "+s.message;if(s.response){i+=", "+s.response.statusCode+", "+s.response.statusText+", "+s.response.body}e.warning(i)}var l=this.getResolvedPath();if(l){s=this.sRefreshGroupId?this.sRefreshGroupId:this.sGroupId;this.oCountHandle=this.oModel.read(this.sPath+"/$count",{context:this.oContext,withCredentials:this.oModel.bWithCredentials,groupId:s,urlParameters:a,success:h,error:o,canonicalRequest:this.bCanonicalRequest})}};C.prototype.refresh=function(t,e){if(typeof t==="string"){e=t;t=false}this.sRefreshGroupId=e;this._refresh(t);this.sRefreshGroupId=undefined};C.prototype._refresh=function(t,e,s){var a,n,h=false,o=this.isRelative()&&this.oContext&&this.oContext.isTransient&&this.oContext.isTransient();if(o){return}this.bPendingRefresh=false;if(!t){if(s){n=this.getResolvedPath();if(n){a=this.oModel.oMetadata._getEntityTypeByPath(n);if(a&&a.entityType in s){h=true}}}if(e&&!h){i(this.aKeys,function(t,s){if(s in e){h=true;return false}})}if(!e&&!s){h=true}}if(t||h){if(this.bSuspended&&!this.bIgnoreSuspend&&!t){this.bPendingRefresh=true;return}this.abortPendingRequest(true);this.resetData();this._fireRefresh({reason:r.Refresh})}};C.prototype._fireRefresh=function(t){if(this.getResolvedPath()){this.bRefresh=true;this.fireEvent("refresh",t)}};C.prototype._checkPathType=function(){var t=this.getResolvedPath();if(t){if(!this._mPathType||!this._mPathType[t]){this._mPathType={};var e=t.lastIndexOf("/");var s,i;if(e>1){i=this.oModel.oMetadata._getEntityTypeByPath(t.substring(0,e));if(i){s=this.oModel.oMetadata._getEntityAssociationEnd(i,t.substring(e+1));if(s&&s.multiplicity==="*"){this._mPathType[t]=true}}}else if(e===0){var a,n=t.substring(1);a=this.oModel.oMetadata._findEntitySetByName(n);if(a){this._mPathType[t]=true}else{var r=this.oModel.oMetadata._getFunctionImportMetadataByName(n);for(var h=0;h<r.length;h++){var o=r[h];if(o.entitySet){a=this.oModel.oMetadata._findEntitySetByName(o.entitySet);if(a){this._mPathType[t]=true}}}}}}return!!this._mPathType[t]}return true};C.prototype.initialize=function(){var t=this.isRelative()&&this.oContext&&this.oContext.isTransient&&this.oContext.isTransient();if(this.oModel.oMetadata&&this.oModel.oMetadata.isLoaded()&&this.bInitial&&!t){if(!this._checkPathType()){e.error("List Binding is not bound against a list for "+this.getResolvedPath())}this.bInitial=false;this._initSortersFilters();if(!this.bSuspended){if(this.bDataAvailable){this._fireChange({reason:r.Change})}else{this._fireRefresh({reason:r.Refresh})}}this.checkDataState()}return this};C.prototype.checkUpdate=function(t,e){var a=this.sChangeReason?this.sChangeReason:r.Change,n=false,h,o=this,l;if(this.bSuspended&&!this.bIgnoreSuspend&&!t||this.bPendingRequest){return}if(this.bInitial){if(this.oContext&&this.oContext.isUpdated()){this.initialize()}return}this.bIgnoreSuspend=false;if(!t&&!this.bNeedsUpdate){l=this.aExpandRefs;var u=this.aKeys.slice();var d=this.checkExpandedList(true);if(!d&&this.useClientMode()){this.applyFilter();this.applySort()}if(!s(l,this.aExpandRefs)){n=true}else if(e){if(this.aKeys.length!==u.length){n=true}else{for(var f in e){if(this.aKeys.indexOf(f)>-1||u.indexOf(f)>-1){n=true;break}}}}else{n=true}if(n&&this.aLastContexts){n=false;var p=this._getContexts(this.iLastStartIndex,this.iLastLength,this.iLastThreshold);if(this.aLastContexts.length!==p.length){n=true}else{i(this.aLastContextData,function(t,e){h=o.getContextData(p[t]);if(e!==h){n=true;return false}})}}}if(t||n||this.bNeedsUpdate){this.bNeedsUpdate=false;this._fireChange({reason:a})}this.sChangeReason=undefined};C.prototype.resetData=function(){this.aKeys=[];this.aAllKeys=null;this.iLength=0;this.bLengthFinal=false;this.sChangeReason=undefined;this.bDataAvailable=false;this.bLengthRequested=false;this.bThresholdRejected=false;if(this.sCountMode==c.None){this.bThresholdRejected=true}};C.prototype.abortPendingRequest=function(t){if(!a(this.mRequestHandles)){this.bSkipDataEvents=true;i(this.mRequestHandles,function(t,e){e.abort()});if(t&&this.oCountHandle){this.oCountHandle.abort()}this.mRequestHandles={};this.bPendingRequest=false}};C.prototype.getDownloadUrl=function(t){var e=[],s;if(t){e.push("$format="+encodeURIComponent(t))}if(this.sSortParams){e.push(this.sSortParams)}if(this.sFilterParams){e.push(this.sFilterParams)}if(this.sCustomParams){e.push(this.sCustomParams)}s=this.getResolvedPath();if(s){return this.oModel._createRequestUrl(s,null,e)}};C.prototype.sort=function(t,e){var s=false;this.bIgnoreSuspend=true;if(!t){t=[]}if(t instanceof p){t=[t]}this.aSorters=t;if(!this.useClientMode()){this.createSortParams(t)}if(!this.bInitial){this.addComparators(t,true);if(this.useClientMode()){if(this.aAllKeys){if(t.length==0){this.applyFilter()}else{this.applySort()}this._fireChange({reason:r.Sort})}else{this.sChangeReason=r.Sort}}else{this.aKeys=[];this.abortPendingRequest(false);this.sChangeReason=r.Sort;this._fireRefresh({reason:this.sChangeReason})}this._fireSort({sorter:t});s=true}if(e){return s}else{return this}};C.prototype.addComparators=function(s,i){var a,n,r=this.oEntityType,h;if(!r){e.warning("Cannot determine sort/filter comparators, as entitytype of the collection is unknown!");return}s.forEach(function(e){if(e.aFilters){this.addComparators(e.aFilters)}else if(!e.fnCompare){a=this.oModel.oMetadata._getPropertyMetadata(r,e.sPath);n=a&&a.type;t(a,"PropertyType for property "+e.sPath+" of EntityType "+r.name+" not found!");h=b.getComparator(n);if(i){e.fnCompare=P(h)}else{e.fnCompare=h;R(n,e)}}}.bind(this))};function P(t){return function(e,s){if(e===s){return 0}if(e===null){return-1}if(s===null){return 1}return t(e,s)}}function R(t,e){switch(t){case"Edm.Decimal":case"Edm.Int64":if(typeof e.oValue1=="number"){e.oValue1=e.oValue1.toString()}if(typeof e.oValue2=="number"){e.oValue2=e.oValue2.toString()}break;case"Edm.Byte":case"Edm.Int16":case"Edm.Int32":case"Edm.SByte":if(typeof e.oValue1=="string"){e.oValue1=parseInt(e.oValue1)}if(typeof e.oValue2=="string"){e.oValue2=parseInt(e.oValue2)}break;case"Edm.Float":case"Edm.Single":case"Edm.Double":if(typeof e.oValue1=="string"){e.oValue1=parseFloat(e.oValue1)}if(typeof e.oValue2=="string"){e.oValue2=parseFloat(e.oValue2)}break;default:}}C.prototype.applySort=function(){var t=this,e;this.aKeys=g.apply(this.aKeys,this.aSorters,function(s,i){e=t.oModel.getContext("/"+s);return t.oModel.getProperty(i,e)})};C.prototype.createSortParams=function(t){this.sSortParams=b.createSortParams(t)};C.prototype.filter=function(t,e,s){var i=false;this.bIgnoreSuspend=true;if(!t){t=[]}if(t instanceof o){t=[t]}this.oModel.checkFilterOperation(t);if(e===d.Application){this.aApplicationFilters=t}else{this.aFilters=t}if(!this.aFilters||!Array.isArray(this.aFilters)){this.aFilters=[]}if(!this.aApplicationFilters||!Array.isArray(this.aApplicationFilters)){this.aApplicationFilters=[]}this.convertFilters();this.oCombinedFilter=u.combineFilters(this.aFilters,this.aApplicationFilters);if(!this.useClientMode()){this.createFilterParams(this.oCombinedFilter)}if(!this.bInitial){this.addComparators(this.aFilters);this.addComparators(this.aApplicationFilters);if(this.useClientMode()){if(this.aAllKeys){this.applyFilter();this.applySort();this._fireChange({reason:r.Filter})}else{this.sChangeReason=r.Filter}}else{this.resetData();this.abortPendingRequest(true);this.sChangeReason=r.Filter;this._fireRefresh({reason:this.sChangeReason})}if(e===d.Application){this._fireFilter({filters:this.aApplicationFilters})}else{this._fireFilter({filters:this.aFilters})}i=true}if(s){return i}else{return this}};C.prototype.convertFilters=function(){this.aFilters=this.aFilters.map(function(t){return t instanceof y?t.convert():t});this.aApplicationFilters=this.aApplicationFilters.map(function(t){return t instanceof y?t.convert():t})};C.prototype.applyFilter=function(){var t=this,e;this.oCombinedFilter=u.combineFilters(this.aFilters,this.aApplicationFilters);this.aKeys=u.apply(this.aAllKeys,this.oCombinedFilter,function(s,i){e=t.oModel.getContext("/"+s);return t.oModel.getProperty(i,e)},this.mNormalizeCache);this.iLength=this.aKeys.length};C.prototype.createFilterParams=function(t){this.sFilterParams=b.createFilterParams(t,this.oModel.oMetadata,this.oEntityType)};C.prototype._initSortersFilters=function(){var t=this.getResolvedPath();if(!t){return}this.oEntityType=this._getEntityType();this.addComparators(this.aSorters,true);this.addComparators(this.aFilters);this.addComparators(this.aApplicationFilters);this.convertFilters();this.oCombinedFilter=u.combineFilters(this.aFilters,this.aApplicationFilters);if(!this.useClientMode()){this.createSortParams(this.aSorters);this.createFilterParams(this.oCombinedFilter)}};C.prototype._getEntityType=function(){var e=this.getResolvedPath();if(e){var s=this.oModel.oMetadata._getEntityTypeByPath(e);t(s,"EntityType for path "+e+" could not be found!");return s}return undefined};C.prototype.resume=function(){this.bIgnoreSuspend=false;this.bSuspended=false;if(this.bPendingRefresh){this._refresh()}else{this.checkUpdate()}};C.prototype.suspend=function(){if(this.bInitial){this.bPendingRefresh=true}f.prototype.suspend.apply(this,arguments)};C.prototype._checkDataStateMessages=function(t,e){if(e){t.setModelMessages(this.oModel.getMessagesByPath(this.sDeepPath,true))}};C.prototype._getFilterForPredicate=function(t){var e=[],s=t.slice(1,-1).split(","),i=this;s.forEach(function(t){var s=t.split("="),a=s[0],n=s[1];if(s.length===1){n=a;a=i.oModel.oMetadata.getKeyPropertyNamesByPath(i.sDeepPath)[0]}e.push(new o(a,l.EQ,b.parseValue(decodeURIComponent(n))))});if(e.length===1){return e[0]}return new o({and:true,filters:e})};C.prototype.requestFilterForMessages=function(t){var e=this.sDeepPath,s=null,i=[],a=new Set,n=this.getResolvedPath(),r=this;if(!n){return Promise.resolve(null)}this.oModel.getMessagesByPath(e,true).forEach(function(s){var i;if(!t||t(s)){s.aFullTargets.forEach(function(t){if(t.startsWith(e)){i=t.slice(e.length).split("/")[0];if(i){a.add(i)}}})}});a.forEach(function(t){i.push(r._getFilterForPredicate(t))});if(i.length===1){s=i[0]}else if(i.length>1){s=new o({filters:i})}return Promise.resolve(s)};return C});