/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./lib/_Helper","sap/ui/base/SyncPromise","sap/ui/model/ChangeReason","sap/ui/model/odata/OperationMode","sap/ui/model/odata/v4/Context"],function(e,t,n,o,i){"use strict";var r=[n.Change,n.Refresh,n.Sort,n.Filter],s="sap.ui.model.odata.v4.ODataBinding",a=/\/\d|\(\$uid=/;function h(){this.mCacheByResourcePath=undefined;this.oCache=null;this.oCachePromise=t.resolve(null);this.mCacheQueryOptions=undefined;this.oFetchCacheCallToken=undefined;this.mLateQueryOptions=undefined;this.sReducedPath=undefined;this.sResumeChangeReason=n.Change}h.prototype.checkBindingParameters=function(e,t){var n=this;Object.keys(e).forEach(function(i){var r=e[i];if(i.indexOf("$$")!==0){return}if(t.indexOf(i)<0){throw new Error("Unsupported binding parameter: "+i)}switch(i){case"$$aggregation":break;case"$$groupId":case"$$updateGroupId":n.oModel.checkGroupId(r,false,"Unsupported value for binding parameter '"+i+"': ");break;case"$$inheritExpandSelect":if(r!==true&&r!==false){throw new Error("Unsupported value for binding parameter "+"'$$inheritExpandSelect': "+r)}if(!n.oOperation){throw new Error("Unsupported binding parameter $$inheritExpandSelect: "+"binding is not an operation binding")}if(e.$expand||e.$select){throw new Error("Must not set parameter $$inheritExpandSelect on a binding "+"which has a $expand or $select binding parameter")}break;case"$$operationMode":if(r!==o.Server){throw new Error("Unsupported operation mode: "+r)}break;case"$$canonicalPath":case"$$noPatch":case"$$ownRequest":case"$$patchWithoutSideEffects":if(r!==true){throw new Error("Unsupported value for binding parameter '"+i+"': "+r)}break;default:throw new Error("Unknown binding-specific parameter: "+i)}})};h.prototype.checkSuspended=function(){var e=this.getRootBinding();if(e&&e.isSuspended()){throw new Error("Must not call method when the binding's root binding is suspended: "+this)}};h.prototype.checkUpdate=function(e){var t=this;if(arguments.length>1){throw new Error("Only the parameter bForceUpdate is supported")}this.checkUpdateInternal(e).catch(function(e){t.oModel.reportError("Failed to update "+t,s,e)})};h.prototype.destroy=function(){this.mCacheByResourcePath=undefined;this.oCachePromise.then(function(e){if(e){e.setActive(false)}},function(){});this.oCache=null;this.oCachePromise=t.resolve(null);this.mCacheQueryOptions=undefined;this.oContext=undefined;this.oFetchCacheCallToken=undefined};h.prototype.doDeregisterChangeListener=function(e,t){this.oCache.deregisterChange(e,t)};h.prototype.fetchCache=function(n){var o,r={},a,h=this;if(!this.bRelative){n=undefined}if(this.oCache){this.oCache.setActive(false)}this.oCache=undefined;a=[this.fetchQueryOptionsForOwnCache(n),this.oModel.oRequestor.ready()];this.mCacheQueryOptions=undefined;this.mLateQueryOptions=undefined;o=t.all(a).then(function(t){var s=t[0].mQueryOptions;h.sReducedPath=t[0].sReducedPath;if(s&&!(n&&n.iIndex===i.VIRTUAL)){return h.fetchResourcePath(n).then(function(t){var i,a,u,c;if(!o||h.oFetchCacheCallToken===r){h.mCacheQueryOptions=Object.assign({},h.oModel.mUriParameters,s);if(h.bRelative){h.mCacheByResourcePath=h.mCacheByResourcePath||{};i=h.mCacheByResourcePath[t];c=n.getReturnValueContextId&&n.getReturnValueContextId();if(i&&i.$returnValueContextId===c){i.setActive(true)}else{a=e.buildPath(n.getPath(),h.sPath).slice(1);i=h.doCreateCache(t,h.mCacheQueryOptions,n,a);h.mCacheByResourcePath[t]=i;i.$deepResourcePath=a;i.$resourcePath=t;i.$returnValueContextId=c}}else{i=h.doCreateCache(t,h.mCacheQueryOptions,n)}h.oCache=i;return i}else{u=new Error("Cache discarded as a new cache has been created");u.canceled=true;throw u}})}h.oCache=null;return null});o.catch(function(e){h.oModel.reportError("Failed to create cache for binding "+h,s,e)});this.oCachePromise=o;this.oFetchCacheCallToken=r};h.prototype.fetchQueryOptionsForOwnCache=function(e){var n,o,i=this.oModel.resolve(this.sPath,e),r=this;function s(e,n){return t.resolve(e).then(function(e){return{mQueryOptions:e,sReducedPath:n||i}})}if(this.oOperation||this.bRelative&&!e||this.isMeta()){return s(undefined)}o=this.doFetchQueryOptions(e);if(this.oModel.bAutoExpandSelect&&this.aChildCanUseCachePromises){o=t.all([o,Promise.resolve().then(function(){return t.all(r.aChildCanUseCachePromises)})]).then(function(e){r.aChildCanUseCachePromises=[];r.updateAggregatedQueryOptions(e[0]);return r.mAggregatedQueryOptions})}if(!this.bRelative||!e.fetchValue){return s(o)}if(this.oModel.bAutoExpandSelect){n=this.mParameters&&Object.keys(r.mParameters).some(function(e){return e[0]!=="$"||e[1]==="$"});if(n){return s(o)}return e.getBinding().fetchIfChildCanUseCache(e,r.sPath,o).then(function(e){return s(e?undefined:o,e)})}if(this.mParameters&&Object.keys(this.mParameters).length){return s(o)}return o.then(function(e){return s(Object.keys(e).length?e:undefined)})};h.prototype.fetchResourcePath=function(n){var o,i,r,s=this;if(!this.bRelative){return t.resolve(this.sPath.slice(1))}n=n||this.oContext;if(!n){return t.resolve()}i=n.getPath();o=n.fetchCanonicalPath&&(this.mParameters&&this.mParameters["$$canonicalPath"]||a.test(i));r=o?n.fetchCanonicalPath():t.resolve(i);return r.then(function(t){return e.buildPath(t,s.sPath).slice(1)})};h.prototype.getGroupId=function(){return this.sGroupId||this.bRelative&&this.oContext&&this.oContext.getGroupId&&this.oContext.getGroupId()||this.oModel.getGroupId()};h.prototype.getRelativePath=function(t){var n;if(t[0]==="/"){n=e.getRelativePath(t,this.oModel.resolve(this.sPath,this.oContext));if(n===undefined&&this.oReturnValueContext){n=e.getRelativePath(t,this.oReturnValueContext.getPath())}return n}return t};h.prototype.getRootBinding=function(){if(this.bRelative&&this.oContext&&this.oContext.getBinding){return this.oContext.getBinding().getRootBinding()}return this.bRelative&&!this.oContext?undefined:this};h.prototype.getRootBindingResumePromise=function(){var e=this.getRootBinding();return e&&e.getResumePromise()||t.resolve()};h.prototype.getUpdateGroupId=function(){return this.sUpdateGroupId||this.bRelative&&this.oContext&&this.oContext.getUpdateGroupId&&this.oContext.getUpdateGroupId()||this.oModel.getUpdateGroupId()};h.prototype.hasPendingChanges=function(){return this.hasPendingChangesForPath("")||this.hasPendingChangesInDependents()};h.prototype.hasPendingChangesForPath=function(e){return this.withCache(function(e,t){return e.hasPendingChangesForPath(t)},e,true).unwrap()};h.prototype.hasPendingChangesInCaches=function(e){var t=this;if(!this.mCacheByResourcePath){return false}return Object.keys(this.mCacheByResourcePath).some(function(n){var o=t.mCacheByResourcePath[n];return o.$deepResourcePath.startsWith(e)&&o.hasPendingChangesForPath("")})};h.prototype.isInitial=function(){throw new Error("Unsupported operation: isInitial")};h.prototype.isRoot=function(){return!this.bRelative||this.oContext&&!this.oContext.getBinding};h.prototype.isRootBindingSuspended=function(){var e=this.getRootBinding();return e&&e.isSuspended()};h.prototype.lockGroup=function(e,t,n,o){return this.oModel.lockGroup(e||this.getGroupId(),this,t,n,o)};h.prototype.refresh=function(e){if(!this.isRoot()){throw new Error("Refresh on this binding is not supported")}if(this.hasPendingChanges()){throw new Error("Cannot refresh due to pending changes")}this.oModel.checkGroupId(e);this.refreshInternal("",e,true).catch(function(){})};h.prototype.removeCachesAndMessages=function(e,t){var n=this.oModel,o,i=this;if(!t){o=n.resolve(this.sPath,this.oContext);if(o){n.reportBoundMessages(o.slice(1),{})}}if(this.mCacheByResourcePath){Object.keys(this.mCacheByResourcePath).forEach(function(o){var r=i.mCacheByResourcePath[o],s=i.mCacheByResourcePath[o].$deepResourcePath;if(e===""||s===e||s.startsWith(e+"/")||s.startsWith(e+"(")){if(!t){n.reportBoundMessages(r.$deepResourcePath,{})}delete i.mCacheByResourcePath[o]}})}};h.prototype.resetChanges=function(){var e=[];this.checkSuspended();this.resetChangesForPath("",e);this.resetChangesInDependents(e);this.resetInvalidDataState();return Promise.all(e).then(function(){})};h.prototype.resetChangesForPath=function(e,t){t.push(this.withCache(function(e,t){e.resetChangesForPath(t)},e).unwrap())};h.prototype.resetInvalidDataState=function(){};h.prototype.setResumeChangeReason=function(e){if(r.indexOf(e)>r.indexOf(this.sResumeChangeReason)){this.sResumeChangeReason=e}};h.prototype.toString=function(){return this.getMetadata().getName()+": "+(this.bRelative?this.oContext+"|":"")+this.sPath};h.prototype.withCache=function(n,o,i,r){var s=i?t.resolve(this.oCache):this.oCachePromise,a,h=this;o=o||"";return s.then(function(t){if(t){a=h.getRelativePath(o);if(a!==undefined){return n(t,a,h)}}else if(t===undefined){return undefined}else if(h.oOperation){return r?n(null,h.getRelativePath(o),h):undefined}if(h.isRelative()&&h.oContext&&h.oContext.withCache){return h.oContext.withCache(n,o[0]==="/"?o:e.buildPath(h.sPath,o),i,r)}return undefined})};function u(e){if(this){h.apply(this,arguments)}else{Object.assign(e,h.prototype)}}u.prototype.doDeregisterChangeListener=h.prototype.doDeregisterChangeListener;u.prototype.destroy=h.prototype.destroy;u.prototype.hasPendingChangesForPath=h.prototype.hasPendingChangesForPath;return u},false);