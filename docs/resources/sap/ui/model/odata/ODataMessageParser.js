/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/model/odata/ODataUtils","sap/ui/core/library","sap/ui/thirdparty/URI","sap/ui/core/message/MessageParser","sap/ui/core/message/Message","sap/base/Log","sap/ui/thirdparty/jquery"],function(e,r,t,s,a,i,o){"use strict";var n=r.MessageType;var u={error:n.Error,warning:n.Warning,success:n.Success,info:n.Information};var l=s.extend("sap.ui.model.odata.ODataMessageParser",{metadata:{publicMethods:["parse","setProcessor","getHeaderField","setHeaderField"]},constructor:function(e,r){s.apply(this);this._serviceUrl=f(this._parseUrl(e).url);this._metadata=r;this._processor=null;this._headerField="sap-message";this._lastMessages=[]}});l.prototype.getHeaderField=function(){return this._headerField};l.prototype.setHeaderField=function(e){this._headerField=e;return this};l.prototype.parse=function(e,r,t,s,a){var o=[];var n={url:r?r.requestUri:e.requestUri,request:r,response:e};if(e.statusCode>=200&&e.statusCode<300){this._parseHeader(o,e,n)}else if(e.statusCode>=400&&e.statusCode<600){this._parseBody(o,e,n)}else{i.warning("No rule to parse OData response with status "+e.statusCode+" for messages")}if(this._processor){this._propagateMessages(o,n,t,s,!a)}else{this._outputMesages(o)}};l.prototype._isNavigationProperty=function(e,r){var t=this._metadata._getEntityTypeByPath(e);if(t){var s=this._metadata._getNavigationPropertyNames(t);return s.indexOf(r)>-1}return false};l.prototype._getAffectedTargets=function(e,r,t,s){var a=o.extend({"":true},t,s);if(r.request&&r.request.key&&r.request.created){a[r.request.key]=true}var i=this._parseUrl(r.url).url;if(i.indexOf(this._serviceUrl)===0){i=i.substr(this._serviceUrl.length+1)}var n=this._metadata._getEntitySetByPath(i);if(n){a[n.name]=true}for(var u=0;u<e.length;++u){var l=e[u].getTarget();if(l){var d=l.replace(/^\/+|\/$/g,"");a[d]=true;var p=d.lastIndexOf("/");if(p>0){var f=d.substr(0,p);var h=d.substr(p);var g=this._isNavigationProperty(f,h);if(!g){a[f]=true}}}}return a};l.prototype._propagateMessages=function(e,r,t,s,a){var o,n=r.request.deepPath,u=[],l=n&&r.request.updateAggregatedMessages,d=r.request.headers&&r.request.headers["sap-messages"]==="transientOnly",p=[],f,h,g,c;function v(e,r){return o[r]||l&&e.fullTarget.startsWith(n)}if(d){u=this._lastMessages;f=e.some(function(e){return!e.getPersistent()});if(f){i.error("Unexpected non-persistent message in response, but requested only "+"transition messages",undefined,"sap.ui.model.odata.ODataMessageParser")}}else{o=this._getAffectedTargets(e,r,t,s);h=r.response.statusCode;g=h>=200&&h<300;this._lastMessages.forEach(function(e){c=e.getTarget().replace(/^\/+|\/$/g,"");var r=c.lastIndexOf(")/");if(r>0){c=c.substr(0,r+1)}if(g||a){if(!e.getPersistent()&&v(e,c)){p.push(e)}else{u.push(e)}}else if(!e.getPersistent()&&e.getTechnical()&&v(e,c)){p.push(e)}else{u.push(e)}})}this.getProcessor().fireMessageChange({oldMessages:p,newMessages:e});this._lastMessages=u.concat(e)};l.prototype._createMessage=function(r,t,s){var i=r["@sap.severity"]?r["@sap.severity"]:r["severity"];i=u[i]?u[i]:i;var o=r.code?r.code:"";var n=typeof r["message"]==="object"&&r["message"]["value"]?r["message"]["value"]:r["message"];var l=r.longtext_url?r.longtext_url:"";var d=false;if(!r.target&&r.propertyref){r.target=r.propertyref}if(typeof r.target==="undefined"){r.target=""}if(r.target.indexOf("/#TRANSIENT#")===0){d=true;r.target=r.target.substr(12)}else if(r.transient){d=true}else if(r.transition){d=true}this._createTarget(r,t);return new a({type:i,code:o,message:n,descriptionUrl:l,target:e._normalizeKey(r.canonicalTarget),processor:this._processor,technical:s,persistent:d,fullTarget:r.deepPath,technicalDetails:{statusCode:t.response.statusCode,headers:t.response.headers}})};l.prototype._getFunctionTarget=function(e,r,t){var s="";var a;if(r.response&&r.response.headers&&r.response.headers["location"]){s=r.response.headers["location"];var o=s.lastIndexOf(this._serviceUrl);if(o>-1){s=s.substr(o+this._serviceUrl.length)}}else{var n=null;if(e.extensions){for(a=0;a<e.extensions.length;++a){if(e.extensions[a].name==="action-for"){n=e.extensions[a].value;break}}}var u;if(n){u=this._metadata._getEntityTypeByName(n)}else if(e.entitySet){u=this._metadata._getEntityTypeByPath(e.entitySet)}else if(e.returnType){u=this._metadata._getEntityTypeByName(e.returnType)}if(u){var l=this._metadata._getEntitySetByType(u);if(l&&u&&u.key&&u.key.propertyRef){var d="";var p;if(u.key.propertyRef.length===1){p=u.key.propertyRef[0].name;if(t.parameters[p]){d=t.parameters[p]}}else{var f=[];for(a=0;a<u.key.propertyRef.length;++a){p=u.key.propertyRef[a].name;if(t.parameters[p]){f.push(p+"="+t.parameters[p])}}d=f.join(",")}s="/"+l.name+"("+d+")"}else if(!l){i.error("Could not determine path of EntitySet for function call: "+t.url)}else{i.error("Could not determine keys of EntityType for function call: "+t.url)}}}return s};l.prototype._createTarget=function(e,r){var t=e.target;var s="";if(t[0]!=="/"){var a="";var i=r.request&&r.request.method?r.request.method:"GET";var o=i==="POST"&&r.response&&r.response.statusCode==201&&r.response.headers&&r.response.headers["location"];var n;if(o){n=r.response.headers["location"]}else if(r.request&&r.request.key&&r.request.created&&r.response&&r.response.statusCode>=400){n=r.request.key}else{n=r.url}var u=this._parseUrl(n);var l=u.url;var d=l.lastIndexOf(this._serviceUrl);if(d>-1){a=l.substr(d+this._serviceUrl.length)}else{a="/"+l}if(!o){var p=this._metadata._getFunctionImportMetadata(a,i);if(p){a=this._getFunctionTarget(p,r,u);s=a}}var f=a.lastIndexOf("/");var h=f>-1?a.substr(f):a;if(!s&&r.request&&r.request.deepPath){s=r.request.deepPath}if(h.indexOf("(")>-1){t=t?a+"/"+t:a;s=e.target?s+"/"+e.target:s}else if(this._metadata._isCollection(a)){t=a+t;s=s+e.target}else{t=t?a+"/"+t:a;s=e.target?s+"/"+e.target:s}}e.canonicalTarget=t;if(this._processor){var g=this._processor.resolve(t,undefined,true);var c=t.split(")").length-1;for(var v=2;v<c;v++){g=this._processor.resolve(g,undefined,true)}e.canonicalTarget=g||t;e.deepPath=this._metadata._getReducedPath(s||e.canonicalTarget)}};l.prototype._parseHeader=function(e,r,t){var s=this.getHeaderField();if(!r.headers){return}for(var a in r.headers){if(a.toLowerCase()===s.toLowerCase()){s=a}}if(!r.headers[s]){return}var o=r.headers[s];var n=null;try{n=JSON.parse(o);e.push(this._createMessage(n,t));if(Array.isArray(n.details)){for(var u=0;u<n.details.length;++u){e.push(this._createMessage(n.details[u],t))}}}catch(e){i.error("The message string returned by the back-end could not be parsed: '"+e.message+"'");return}};l.prototype._parseBody=function(e,r,t){var s=d(r);if(s&&s.indexOf("xml")>-1){this._parseBodyXML(e,r,t,s)}else{this._parseBodyJSON(e,r,t)}g(e)};l.prototype._parseBodyXML=function(e,r,t,s){try{var a=(new DOMParser).parseFromString(r.body,s);var o=h(a,["error","errordetail"]);for(var u=0;u<o.length;++u){var l=o[u];var d={};d["severity"]=n.Error;for(var p=0;p<l.childNodes.length;++p){var f=l.childNodes[p];var g=f.nodeName;if(g==="errordetails"||g==="details"||g==="innererror"||g==="#text"){continue}if(g==="message"&&f.hasChildNodes()&&f.firstChild.nodeType!==window.Node.TEXT_NODE){for(var c=0;c<f.childNodes.length;++c){if(f.childNodes[c].nodeName==="value"){d["message"]=f.childNodes[c].text||f.childNodes[c].textContent}}}else{d[f.nodeName]=f.text||f.textContent}}e.push(this._createMessage(d,t,true))}}catch(e){i.error("Error message returned by server could not be parsed")}};l.prototype._parseBodyJSON=function(e,r,t){try{var s=JSON.parse(r.body);var a;if(s["error"]){a=s["error"]}else{a=s["odata.error"]}if(!a){i.error("Error message returned by server did not contain error-field");return}a["severity"]=n.Error;e.push(this._createMessage(a,t,true));var o=null;if(Array.isArray(a.details)){o=a.details}else if(a.innererror&&Array.isArray(a.innererror.errordetails)){o=a.innererror.errordetails}else{o=[]}for(var u=0;u<o.length;++u){e.push(this._createMessage(o[u],t,true))}}catch(e){i.error("Error message returned by server could not be parsed")}};l.prototype._parseUrl=function(e){var r={url:e,parameters:{},hash:""};var s=-1;s=e.indexOf("#");if(s>-1){r.hash=r.url.substr(s+1);r.url=r.url.substr(0,s)}s=e.indexOf("?");if(s>-1){var a=r.url.substr(s+1);r.parameters=t.parseQuery(a);r.url=r.url.substr(0,s)}return r};l.prototype._outputMesages=function(e){for(var r=0;r<e.length;++r){var t=e[r];var s="[OData Message] "+t.getMessage()+" - "+t.getDescription()+" ("+t.getTarget()+")";switch(e[r].getType()){case n.Error:i.error(s);break;case n.Warning:i.warning(s);break;case n.Success:i.debug(s);break;case n.Information:case n.None:default:i.info(s);break}}};function d(e){if(e&&e.headers){for(var r in e.headers){if(r.toLowerCase()==="content-type"){return e.headers[r].replace(/([^;]*);.*/,"$1")}}}return false}var p=document.createElement("a");function f(e){p.href=e;return t.parse(p.href).path}function h(e,r){var t=[];var s={};for(var a=0;a<r.length;++a){s[r[a]]=true}var i=e;while(i){if(s[i.tagName]){t.push(i)}if(i.hasChildNodes()){i=i.firstChild}else{while(!i.nextSibling){i=i.parentNode;if(!i||i===e){i=null;break}}if(i){i=i.nextSibling}}}return t}function g(e){if(e.length>1){for(var r=1;r<e.length;r++){if(e[0].getCode()==e[r].getCode()&&e[0].getMessage()==e[r].getMessage()){e.shift();break}}}}return l});