/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./library","sap/ui/core/Control","./Button","./SplitButton","sap/ui/Device","sap/ui/core/EnabledPropagator","sap/ui/core/library","sap/ui/core/Popup","sap/ui/core/LabelEnablement","./MenuButtonRenderer"],function(t,e,i,o,n,s,r,a,u,p){"use strict";var l=t.MenuButtonMode;var h=r.TextDirection;var c=t.ButtonType;var g=a.Dock;var d=["buttonMode","useDefaultActionOnly","width","menuPosition"];var f=e.extend("sap.m.MenuButton",{metadata:{library:"sap.m",properties:{text:{type:"string",group:"Misc",defaultValue:null},type:{type:"sap.m.ButtonType",group:"Appearance",defaultValue:c.Default},width:{type:"sap.ui.core.CSSSize",group:"Misc",defaultValue:null},enabled:{type:"boolean",group:"Behavior",defaultValue:true},icon:{type:"sap.ui.core.URI",group:"Appearance",defaultValue:null},activeIcon:{type:"sap.ui.core.URI",group:"Misc",defaultValue:null},iconDensityAware:{type:"boolean",group:"Misc",defaultValue:true},textDirection:{type:"sap.ui.core.TextDirection",group:"Appearance",defaultValue:h.Inherit},buttonMode:{type:"sap.m.MenuButtonMode",group:"Misc",defaultValue:l.Regular},menuPosition:{type:"sap.ui.core.Popup.Dock",group:"Misc",defaultValue:g.BeginBottom},useDefaultActionOnly:{type:"boolean",group:"Behavior",defaultValue:false}},aggregations:{menu:{type:"sap.m.Menu",multiple:false,singularName:"menu"},_button:{type:"sap.ui.core.Control",multiple:false,visibility:"hidden"}},associations:{ariaDescribedBy:{type:"sap.ui.core.Control",multiple:true,singularName:"ariaDescribedBy"},ariaLabelledBy:{type:"sap.ui.core.Control",multiple:true,singularName:"ariaLabelledBy"}},events:{defaultAction:{}},defaultAggregation:"menu",designtime:"sap/m/designtime/MenuButton.designtime",dnd:{draggable:true,droppable:false}}});s.call(f.prototype);f.prototype.init=function(){this._initButtonControl()};f.prototype.exit=function(){if(this._sDefaultText){this._sDefaultText=null}if(this._sDefaultIcon){this._sDefaultIcon=null}if(this._iInitialTextBtnContentWidth){this._iInitialTextBtnContentWidth=null}if(this._lastActionItemId){this._lastActionItemId=null}if(this.getMenu()){this.getMenu().detachClosed(this._menuClosed,this)}};f.prototype.onBeforeRendering=function(){if(!this._sDefaultText){this._sDefaultText=this.getText()}if(!this._sDefaultIcon){this._sDefaultIcon=this.getIcon()}this._updateButtonControl();this._attachMenuEvents()};f.prototype._needsWidth=function(){return this._isSplitButton()&&this.getWidth()===""};f.prototype._getTextBtnContentDomRef=function(){return this._getButtonControl()._getTextButton().getDomRef("content")};f.prototype.onAfterRendering=function(){if(this._needsWidth()&&sap.ui.getCore().isThemeApplied()&&this._getTextBtnContentDomRef()&&this._getInitialTextBtnWidth()>0){this._getTextBtnContentDomRef().style.width=this._getInitialTextBtnWidth()+"px"}this._setAriaHasPopup()};f.prototype.onThemeChanged=function(t){if(this._needsWidth()&&this.getDomRef()&&!this._iInitialTextBtnContentWidth&&this._getTextBtnContentDomRef()&&this._getInitialTextBtnWidth()>0){this._getTextBtnContentDomRef().style.width=this._getInitialTextBtnWidth()+"px"}};f.prototype._getInitialTextBtnWidth=function(){if(!this._iInitialTextBtnContentWidth){this._iInitialTextBtnContentWidth=Math.ceil(this._getTextBtnContentDomRef().getBoundingClientRect().width)}return this._iInitialTextBtnContentWidth};f.prototype._setAriaHasPopup=function(){var t=this._getButtonControl(),e=this._isSplitButton()?t._getArrowButton():t;e.$().attr("aria-haspopup","menu")};f.prototype.setButtonMode=function(t){var i=this.getTooltip();e.prototype.setProperty.call(this,"buttonMode",t,true);this._getButtonControl().destroy();this._initButtonControl();for(var o in this.mProperties){if(this.mProperties.hasOwnProperty(o)&&d.indexOf(o)<0){this._getButtonControl().setProperty(o,this.mProperties[o],true)}}if(i){this._getButtonControl().setTooltip(i)}if(!this._isSplitButton()&&this._sDefaultText){this.setText(this._sDefaultText)}else if(!this.getUseDefaultActionOnly()&&this._getLastSelectedItem()){this.setText(sap.ui.getCore().byId(this._getLastSelectedItem()).getText())}if(!this._isSplitButton()&&this._sDefaultIcon){this.setIcon(this._sDefaultIcon)}else if(!this.getUseDefaultActionOnly()&&this._getLastSelectedItem()){this.setIcon(sap.ui.getCore().byId(this._getLastSelectedItem()).getIcon())}this.invalidate();return this};f.prototype._initButton=function(){var t=new i(this.getId()+"-internalBtn",{width:"100%"});t.attachPress(this._handleButtonPress,this);return t};f.prototype._initSplitButton=function(){var t=new o(this.getId()+"-internalSplitBtn",{width:"100%"});t.attachPress(this._handleActionPress,this);t.attachArrowPress(this._handleButtonPress,this);return t};f.prototype._initButtonControl=function(){var t;if(this._isSplitButton()){t=this._initSplitButton()}else{t=this._initButton()}this.setAggregation("_button",t,true)};f.prototype._updateButtonControl=function(){this._getButtonControl().setText(this.getText())};f.prototype._getButtonControl=function(){return this.getAggregation("_button")};f.prototype._handleButtonPress=function(t){var e=this.getMenu(),i={zero:"0 0",plus2_right:"0 +2",minus2_right:"0 -2",plus2_left:"+2 0",minus2_left:"-2 0"};if(this._bPopupOpen){this.getMenu().close();return}if(!e){return}if(!e.getTitle()){e.setTitle(this.getText())}var o=[this,t];switch(this.getMenuPosition()){case g.BeginTop:o.push(g.BeginBottom,g.BeginTop,i.plus2_right);break;case g.BeginCenter:o.push(g.BeginCenter,g.BeginCenter,i.zero);break;case g.LeftTop:o.push(g.RightBottom,g.LeftBottom,i.plus2_left);break;case g.LeftCenter:o.push(g.RightCenter,g.LeftCenter,i.plus2_left);break;case g.LeftBottom:o.push(g.RightTop,g.LeftTop,i.plus2_left);break;case g.CenterTop:o.push(g.CenterBottom,g.CenterTop,i.plus2_left);break;case g.CenterCenter:o.push(g.CenterCenter,g.CenterCenter,i.zero);break;case g.CenterBottom:o.push(g.CenterTop,g.CenterBottom,i.minus2_right);break;case g.RightTop:o.push(g.LeftBottom,g.RightBottom,i.minus2_left);break;case g.RightCenter:o.push(g.LeftCenter,g.RightCenter,i.minus2_left);break;case g.RightBottom:o.push(g.LeftTop,g.RightTop,i.minus2_left);break;case g.EndTop:o.push(g.EndBottom,g.EndTop,i.plus2_right);break;case g.EndCenter:o.push(g.EndCenter,g.EndCenter,i.zero);break;case g.EndBottom:o.push(g.EndTop,g.EndBottom,i.minus2_right);break;default:case g.BeginBottom:o.push(g.BeginTop,g.BeginBottom,i.minus2_right);break}e.openBy.apply(e,o);this._writeAriaAttributes();if(this._isSplitButton()&&!n.system.phone){this._getButtonControl().setArrowState(true)}};f.prototype._handleActionPress=function(){var t=this._getLastSelectedItem(),e;if(!this.getUseDefaultActionOnly()&&t){e=sap.ui.getCore().byId(t);this.getMenu().fireItemSelected({item:e})}else{this.fireDefaultAction()}};f.prototype._menuClosed=function(){var t=this._getButtonControl(),e=t;if(this._isSplitButton()){t.setArrowState(false);e=t._getArrowButton()}e.$().removeAttr("aria-controls")};f.prototype._menuItemSelected=function(t){var e=t.getParameter("item");this.fireEvent("_menuItemSelected",{item:e});this._bPopupOpen=false;if(!this._isSplitButton()||this.getUseDefaultActionOnly()||!e){return}this._lastActionItemId=e.getId();!!this._sDefaultText&&this.setText(e.getText());!!this._sDefaultIcon&&this.setIcon(e.getIcon())};f.prototype._getLastSelectedItem=function(){return this._lastActionItemId};f.prototype._attachMenuEvents=function(){if(this.getMenu()){this.getMenu().attachClosed(this._menuClosed,this);this.getMenu().attachItemSelected(this._menuItemSelected,this)}};f.prototype._isSplitButton=function(){return this.getButtonMode()===l.Split};f.prototype.setProperty=function(t,i,o){function n(t){var e=[c.Up,c.Back,c.Unstyled];return e.indexOf(t)!==-1}if(t==="type"&&n(i)){return this}if(t==="text"){this._sDefaultText=i}switch(t){case"activeIcon":case"iconDensityAware":case"textDirection":case"enabled":this._getButtonControl().setProperty(t,i);break}return e.prototype.setProperty.apply(this,arguments)};f.prototype.setTooltip=function(t){this._getButtonControl().setTooltip(t);return e.prototype.setTooltip.apply(this,arguments)};f.prototype.setText=function(t){i.prototype.setProperty.call(this,"text",t);this._getButtonControl().setText(t);return this};f.prototype.setType=function(t){i.prototype.setProperty.call(this,"type",t);this._getButtonControl().setType(t);return this};f.prototype.setIcon=function(t){i.prototype.setProperty.call(this,"icon",t);this._getButtonControl().setIcon(t);return this};f.prototype.addAriaLabelledBy=function(t){this.getAggregation("_button").addAssociation("ariaLabelledBy",t);return e.prototype.addAssociation.call(this,"ariaLabelledBy",t)};f.prototype.addAriaDescribedBy=function(t){this.getAggregation("_button").addAssociation("ariaDescribedBy",t);return e.prototype.addAssociation.call(this,"ariaDescribedBy",t)};f.prototype.removeAriaLabelledBy=function(t){this.getAggregation("_button").removeAssociation("ariaLabelledBy",t);return e.prototype.removeAssociation.call(this,"ariaLabelledBy",t)};f.prototype.removeAriaDescribedBy=function(t){this.getAggregation("_button").removeAssociation("ariaDescribedBy",t);return e.prototype.removeAssociation.call(this,"ariaDescribedBy",t)};f.prototype.removeAllAriaLabelledBy=function(t){this.getAggregation("_button").removeAllAssociation("ariaLabelledBy");return e.prototype.removeAllAssociation.call(this,"ariaLabelledBy")};f.prototype.removeAllAriaDescribedBy=function(){this.getAggregation("_button").removeAllAssociation("ariaDescribedBy");return e.prototype.removeAllAssociation.call(this,"ariaDescribedBy")};f.prototype.getFocusDomRef=function(){return this._getButtonControl().getDomRef()};f.prototype.onsapup=function(t){this.openMenuByKeyboard()};f.prototype.onsapdown=function(t){this.openMenuByKeyboard()};f.prototype.onsapupmodifiers=function(t){this.openMenuByKeyboard()};f.prototype.onsapdownmodifiers=function(t){this.openMenuByKeyboard()};f.prototype.onsapshow=function(t){this.openMenuByKeyboard();!!t&&t.preventDefault()};f.prototype.ontouchstart=function(){this._bPopupOpen=this.getMenu()&&this.getMenu()._getMenu()&&this.getMenu()._getMenu().getPopup().isOpen()};f.prototype.openMenuByKeyboard=function(){if(!this._isSplitButton()){this._handleButtonPress(true)}};f.prototype._writeAriaAttributes=function(){var t=this._getButtonControl(),e=this._isSplitButton()?t._getArrowButton():t,i=this.getMenu();if(i){e.$().attr("aria-controls",i.getDomRefId())}};f.prototype.getIdForLabel=function(){return this.getId()+"-internalBtn"};f.prototype._ensureBackwardsReference=function(){var t=this._getButtonControl(),e=t.getAriaLabelledBy(),i=u.getReferencingLabels(this);i.forEach(function(i){if(e&&e.indexOf(i)===-1){t.addAriaLabelledBy(i)}});return this};return f});