/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./library","sap/ui/core/Control","sap/ui/core/IconPool","./AvatarRenderer","sap/ui/events/KeyCodes","sap/base/Log"],function(e,t,a,i,r,s){"use strict";var o=e.AvatarType;var n=e.AvatarImageFitType;var p=e.AvatarColor;var l=e.AvatarSize;var u=e.AvatarShape;var h=Object.keys(p).filter(function(e){return e.indexOf("Accent")!==-1});var c=t.extend("sap.m.Avatar",{metadata:{library:"sap.m",properties:{src:{type:"sap.ui.core.URI",group:"Data",defaultValue:null},initials:{type:"string",group:"Data",defaultValue:null},displayShape:{type:"sap.m.AvatarShape",group:"Appearance",defaultValue:u.Circle},displaySize:{type:"sap.m.AvatarSize",group:"Appearance",defaultValue:l.S},customDisplaySize:{type:"sap.ui.core.CSSSize",group:"Appearance",defaultValue:"3rem"},customFontSize:{type:"sap.ui.core.CSSSize",group:"Appearance",defaultValue:"1.125rem"},imageFitType:{type:"sap.m.AvatarImageFitType",group:"Appearance",defaultValue:n.Cover},fallbackIcon:{type:"string",group:"Data",defaultValue:null},backgroundColor:{type:"sap.m.AvatarColor",group:"Appearance",defaultValue:p.Accent6},showBorder:{type:"boolean",group:"Appearance",defaultValue:false}},aggregations:{detailBox:{type:"sap.m.LightBox",multiple:false,bindable:"bindable"}},associations:{ariaDescribedBy:{type:"sap.ui.core.Control",multiple:true,singularName:"ariaDescribedBy"},ariaLabelledBy:{type:"sap.ui.core.Control",multiple:true,singularName:"ariaLabelledBy"}},events:{press:{}},dnd:{draggable:true,droppable:false},designtime:"sap/m/designtime/Avatar.designtime"}});c.DEFAULT_CIRCLE_PLACEHOLDER="sap-icon://person-placeholder";c.DEFAULT_SQUARE_PLACEHOLDER="sap-icon://product";c.prototype.init=function(){this._sActualType=null;this._bIsDefaultIcon=true;this._sImageFallbackType=null;this._sPickedRandomColor=null};c.prototype.exit=function(){if(this._icon){this._icon.destroy()}if(this._fnLightBoxOpen){this._fnLightBoxOpen=null}this._sPickedRandomColor=null};c.prototype.setDetailBox=function(e){var t=this.getDetailBox();if(e){if(e===t){return this}if(t){this.detachPress(this._fnLightBoxOpen,t)}this._fnLightBoxOpen=e.open;this.attachPress(this._fnLightBoxOpen,e)}else if(this._fnLightBoxOpen){this.detachPress(this._fnLightBoxOpen,t);this._fnLightBoxOpen=null}return this.setAggregation("detailBox",e)};c.prototype.clone=function(){var e=t.prototype.clone.apply(this,arguments),a=e.getDetailBox();if(a){e.detachPress(this._fnLightBoxOpen,this.getDetailBox());e._fnLightBoxOpen=a.open;e.attachPress(e._fnLightBoxOpen,a)}return e};c.prototype.attachPress=function(){Array.prototype.unshift.apply(arguments,["press"]);t.prototype.attachEvent.apply(this,arguments);if(this.hasListeners("press")){this.$().attr("tabindex","0");this.$().attr("role","button")}return this};c.prototype.detachPress=function(){Array.prototype.unshift.apply(arguments,["press"]);t.prototype.detachEvent.apply(this,arguments);if(!this.hasListeners("press")){this.$().removeAttr("tabindex");this.$().attr("role","img")}return this};c.prototype.ontap=function(){this.firePress({})};c.prototype.onkeydown=function(e){if(e.which===r.SHIFT||e.which===r.ESCAPE){this._bShouldInterupt=this._bSpacePressed}if(e.which===r.SPACE){this._bSpacePressed=true;e.preventDefault()}if(e.which===r.ENTER){this.firePress({})}};c.prototype.onkeyup=function(e){if(e.which===r.SPACE){if(!this._bShouldInterupt){this.firePress({})}this._bShouldInterupt=false;this._bSpacePressed=false;e.stopPropagation()}};c.prototype._areInitialsValid=function(e){var t=/^[a-zA-Z]{1,2}$/;if(!t.test(e)){s.warning("Initials should consist of only 1 or 2 latin letters",this);this._sActualType=o.Icon;this._bIsDefaultIcon=true;return false}return true};c.prototype._validateSrc=function(e){if(a.isIconURI(e)){this._sActualType=o.Icon;this._bIsDefaultIcon=a.getIconInfo(e)?false:true}else{this._bIsDefaultIcon=true;this._sActualType=o.Image;this.preloadedImage=new window.Image;this.preloadedImage.src=e;this.preloadedImage.onload=this._onImageLoad.bind(this);this.preloadedImage.onerror=this._onImageError.bind(this)}return this};c.prototype._getActualDisplayType=function(){var e=this.getSrc(),t=this.getInitials();if(e){this._validateSrc(e)}else if(t&&this._areInitialsValid(t)){this._sActualType=o.Initials}else{s.warning("No src and initials were provided",this);this._sActualType=o.Icon;this._bIsDefaultIcon=true}return this._sActualType};c.prototype._getImageFallbackType=function(){var e=this.getInitials();this._sImageFallbackType=e&&this._areInitialsValid(e)?o.Initials:o.Icon;return this._sImageFallbackType};c.prototype._getDefaultIconPath=function(e){var t=null,i=this.getFallbackIcon();if(i&&a.isIconURI(i)){t=i}else if(e===u.Circle){t=c.DEFAULT_CIRCLE_PLACEHOLDER}else if(e===u.Square){t=c.DEFAULT_SQUARE_PLACEHOLDER}return t};c.prototype._getIcon=function(){var e=this.getSrc(),t=this.getDisplayShape();if(this._bIsDefaultIcon){e=this._getDefaultIconPath(t)}if(!this._icon){this._icon=a.createControlByURI({alt:"Image placeholder",src:e})}else if(this._icon.getSrc()!==e){this._icon.setSrc(e)}return this._icon};c.prototype._getDefaultTooltip=function(){return sap.ui.getCore().getLibraryResourceBundle("sap.m").getText("AVATAR_TOOLTIP")};c.prototype._onImageLoad=function(){delete this.preloadedImage};c.prototype._onImageError=function(){var e=this._getImageFallbackType();this.$().removeClass("sapFAvatarImage").addClass("sapFAvatar"+e);delete this.preloadedImage};c.prototype._getActualBackgroundColor=function(){var e=this.getBackgroundColor();if(e===p.Random){if(this._sPickedRandomColor){return this._sPickedRandomColor}e=this._sPickedRandomColor=p[h[h.length*Math.random()<<0]]}else{this._sPickedRandomColor=null}return e};return c});