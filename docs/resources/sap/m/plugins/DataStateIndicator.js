/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./PluginBase","sap/ui/core/Core","sap/ui/base/ManagedObjectObserver"],function(e,t,a){"use strict";var i=e.extend("sap.m.plugins.DataStateIndicator",{metadata:{library:"sap.m",properties:{filter:{type:"function",invalidate:false}},events:{dataStateChange:{allowPreventDefault:true,parameters:{dataState:{type:"sap.ui.model.DataState"}}}}}});i.prototype.isApplicable=function(t){if(!t.addAriaLabelledBy||!e.prototype.isApplicable.apply(this,arguments)||!t.getMetadata().getAllPrivateAggregations()["_messageStrip"]||!this._getBindingName()){return false}return true};i.prototype.onActivate=function(e){var t=this._getBindingName();var i=e.getBinding(t);if(i){i.attachAggregatedDataStateChange(this._onAggregatedDataStateChange,this);this._processDataState(i.getDataState())}this._oObserver=new a(this._observeChanges.bind(this));this._oObserver.observe(e,{bindings:[t]})};i.prototype.onDeactivate=function(e){var t=this._getBindingName();var a=e.getBinding(t);if(a){a.detachAggregatedDataStateChange(this._onAggregatedDataStateChange,this);a.getDataState().getMessages().forEach(function(t){t.removeControlId(e.getId())})}if(this._oMessageStrip){this._oMessageStrip.destroy();this._oMessageStrip=null}this._oObserver.unobserve(e,{bindings:[t]});this._oObserver.destroy();this._oObserver=null};i.prototype.showMessage=function(e,t){if(!this.getEnabled()||!this.getControl()||!e&&!this._oMessageStrip){return}if(this._oMessageStrip){this._oMessageStrip.setText(e).setType(t).setVisible(!!e);return}sap.ui.require(["sap/m/MessageStrip"],function(a){var i=this.getControl();this._oMessageStrip=new a({showCloseButton:true,showIcon:true}).addStyleClass("sapUiTinyMargin");i.setAggregation("_messageStrip",this._oMessageStrip);i.addAriaLabelledBy(this._oMessageStrip);this.showMessage(e,t)}.bind(this))};i.prototype.refresh=function(){if(this.isActive()){var e=this._getBindingName();var t=this.getControl().getBinding(e);if(t){this._processDataState(t.getDataState())}}};i.prototype._getBindingName=function(){return this.getControlPluginConfig("defaultBindingName")};i.prototype._translate=function(e){var a="DATASTATE_"+e;var i=this.getControl().getMetadata();var s=i.getLibraryName();var r=i.getName().split(".").pop().toUpperCase();var n=t.getLibraryResourceBundle(s);var g=r+"_"+a;if(n.hasText(g)){return n.getText(g)}if(s=="sap.m"){return n.getText(a)}return t.getLibraryResourceBundle("sap.m").getText(a)};i.prototype._processDataState=function(e){if(!e||!e.getChanges().messages||!this.fireDataStateChange({dataState:e},true)){return}var a=e.getMessages();var i=this.getControl();var s=this.getFilter();if(s){a=a.filter(function(e){return s(e,i)})}if(a.length){var r=a[0];var n=this._getBindingName();var g=i.getBinding(n).getPath();var o={None:0,Information:1,Success:2,Warning:4,Error:8};var h=false;var p="";var d=0;var l="";a.forEach(function(e){if(e.getControlIds().indexOf(i.getId())==-1){e.addControlId(i.getId());h=true}d|=o[e.getType()]});if(a.length==1&&r.getTarget()&&r.getTarget().endsWith(g)){l=r.getMessage()}else{if(d&o.Error&&d&o.Warning){p="ISSUE"}else if(d&o.Error){p="ERROR"}else if(d&o.Warning){p="WARNING"}else if(d&o.Success||d&o.Information){p="NOTIFICATION"}if(p){l=this._translate(p)}}this.showMessage(l,r.getType());if(h){t.getMessageManager().getMessageModel().checkUpdate(false,true)}}else{this.showMessage("")}};i.prototype._onAggregatedDataStateChange=function(e){this._processDataState(e.getParameter("dataState"))};i.prototype._observeChanges=function(e){var t=e.bindingInfo.binding;if(t){var a=e.mutation=="ready"?"attach":"detach";t[a+"AggregatedDataStateChange"](this._onAggregatedDataStateChange,this)}};e.setConfig({"sap.m.ListBase":{defaultBindingName:"items"},"sap.ui.table.Table":{defaultBindingName:"rows"}},i);return i});