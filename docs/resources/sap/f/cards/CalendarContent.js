/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/f/library","sap/f/cards/BaseContent","sap/f/cards/IconFormatter","sap/f/cards/BindingHelper","sap/f/cards/BindingResolver","sap/f/PlanningCalendarInCard","sap/f/PlanningCalendarInCardRow","sap/f/PlanningCalendarInCardLegend","sap/m/library","sap/m/PlanningCalendar","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/unified/CalendarAppointment","sap/ui/unified/DateTypeRange","sap/ui/unified/CalendarLegendItem"],function(t,e,a,i,n,o,r,s,p,d,l,m,h,g,f){"use strict";var _=t.cards.AreaType,c=p.PlanningCalendarBuiltInView;var u=e.extend("sap.f.cards.CalendarContent",{renderer:{}});u.prototype._createCalendar=function(){this._oCalendar=new o(this.getId()+"-PC",{showWeekNumbers:true,builtInViews:[c.OneMonth],rows:[new r(this.getId()+"-Row",{})],intervalSelect:function(t){this._setParameters(t,t.getParameter("startDate"))}.bind(this)});this.setAggregation("_content",this._oCalendar);this._oCalendar.attachEvent("_todayPressed",new Date,this._setParameters)};u.prototype.init=function(){e.prototype.init.apply(this,arguments);this._createCalendar();this.fireEvent("_actionContentReady")};u.prototype.exit=function(){e.prototype.exit.apply(this,arguments);if(this._oAppointmentTemplate){this._oAppointmentTemplate.destroy();this._oAppointmentTemplate=null}if(this._oHeaderTemplate){this._oHeaderTemplate.destroy();this._oHeaderTemplate=null}if(this._oSpecialDateTemplate){this._oSpecialDateTemplate.destroy();this._oSpecialDateTemplate=null}if(this._oCalendarLegendItemTemplate){this._oCalendarLegendItemTemplate.destroy();this._oCalendarLegendItemTemplate=null}if(this._oAppointmentLegendItemTemplate){this._oAppointmentLegendItemTemplate.destroy();this._oAppointmentLegendItemTemplate=null}if(this._oActions){this._oActions.destroy();this._oActions=null}};u.prototype.onAfterRendering=function(){var t;if(!this._bIsDataReady){t=this.getParent();if(t.isReady()){this._setParameters()}else{t.attachEventOnce("_ready",this._setParametersInModel,this)}}};u.prototype.setConfiguration=function(t){e.prototype.setConfiguration.apply(this,arguments);if(!t){return this}if(t.item){this._addItem(t.item)}if(t.specialDate){this._addSpecialDate(t.specialDate)}if(t.legendItem){this._addLegendItem(t.legendItem)}if(t.date){this._addDate(t.date)}if(t.maxItems){this._addMaxItems(t.maxItems)}if(t.maxLegendItems){this._addMaxLegendItems(t.maxLegendItems)}if(t.noItemsText){this._addNoItemsText(t.noItemsText)}if(t.moreItems&&t.moreItems.actions){this._oActions.setAreaType(_.Content);this._oActions.attach(t.moreItems,this._oCalendar.getRows()[0]._getMoreButton())}return this};u.prototype._setParameters=function(t,e){var a=e?e:this._oCalendar.getStartDate(),i=new Date(a.getFullYear(),a.getMonth(),a.getDate()),n=new Date(a.getFullYear(),a.getMonth(),a.getDate()),o=this.getConfiguration&&this.getConfiguration(),r=o&&o.item&&o.item.path,s,p,d,l,m;n.setDate(n.getDate()+1);d=r?this.getModel().getProperty(r).filter(function(t){var e=new Date(t.start).getTime(),a=new Date(t.end).getTime();if(e>=i.getTime()&&e<n.getTime()||a>=i.getTime()&&a<n.getTime()||e<=i.getTime()&&a>n.getTime()){return t}}):[];if(o&&typeof o.maxItems==="object"){s=o&&this.getConfiguration().maxItems&&"/"+this.getConfiguration().maxItems.binding.getPath();p=this.getModel().getProperty(s)}else{p=o&&this.getConfiguration().maxItems}m=d.length;if(m<p){l=m}else{l=p}this._bIsDataReady=true;this.getModel("parameters").setProperty("/visibleItems",l);this.getModel("parameters").setProperty("/allItems",m)};u.prototype.dateFormatter=function(t){return new Date(t)};u.prototype._addItem=function(t){var e={title:t.template.title,text:t.template.text,type:t.template.type},n,o={title:t.template.title,text:t.template.text,type:t.template.type},r;if(t.template.startDate){e.startDate=i.formattedProperty(t.template.startDate,this.dateFormatter)}if(t.template.endDate){e.endDate=i.formattedProperty(t.template.endDate,this.dateFormatter)}if(t.template.icon&&t.template.icon.src){e.icon=i.formattedProperty(t.template.icon.src,function(t){return a.formatSrc(t,this._sAppId)}.bind(this))}this._oAppointmentTemplate=new h(e);n={path:t.path,template:this._oAppointmentTemplate,filters:new l({path:"visualization",operator:m.Contains,value1:"appointment"})};this._bindAggregation("appointments",this._oCalendar.getRows()[0],n);if(t.template.startDate){o.startDate=i.formattedProperty(t.template.startDate,this.dateFormatter)}if(t.template.endDate){o.endDate=i.formattedProperty(t.template.endDate,this.dateFormatter)}if(t.template.icon&&t.template.icon.src){o.icon=i.formattedProperty(t.template.icon.src,function(t){return a.formatSrc(t,this._sAppId)}.bind(this))}this._oHeaderTemplate=new h(o);r={path:t.path,template:this._oHeaderTemplate,filters:new l({path:"visualization",operator:m.Contains,value1:"blocker"})};this._bindAggregation("intervalHeaders",this._oCalendar.getRows()[0],r)};u.prototype._addSpecialDate=function(t){var e=t.template,a;if(e.startDate){e.startDate=i.formattedProperty(e.startDate,this.dateFormatter)}if(e.endDate){e.endDate=i.formattedProperty(e.endDate,this.dateFormatter)}this._oSpecialDateTemplate=new g(e);a={path:t.path,template:this._oSpecialDateTemplate};this._bindAggregation("specialDates",this._oCalendar,a)};u.prototype._addLegendItem=function(t){var e={text:t.template.text,type:t.template.type},a={text:t.template.text,type:t.template.type},i,n;this._oCalendarLegendItemTemplate=new f(e);i={path:t.path,template:this._oCalendarLegendItemTemplate,filters:new l({path:"category",operator:m.Contains,value1:"calendar"})};this._bindAggregation("items",this._oCalendar._getLegend(),i);this._oAppointmentLegendItemTemplate=new f(a);n={path:t.path,template:this._oAppointmentLegendItemTemplate,filters:new l({path:"category",operator:m.Contains,value1:"appointment"})};this._bindAggregation("appointmentItems",this._oCalendar._getLegend(),n)};u.prototype._addDate=function(t){if(n.isBindingInfo(t)){t&&this._oCalendar.bindProperty("startDate",i.formattedProperty(t,this.dateFormatter))}else{this._oCalendar.setStartDate(this.dateFormatter(t))}};u.prototype._addMaxItems=function(t){if(n.isBindingInfo(t)){t&&this._oCalendar.getRows()[0].bindProperty("visibleAppointmentsCount",t)}else{this._oCalendar.getRows()[0].setVisibleAppointmentsCount(t)}};u.prototype._addMaxLegendItems=function(t){if(n.isBindingInfo(t)){t&&this._oCalendar._getLegend().bindProperty("visibleLegendItemsCount",t)}else{this._oCalendar._getLegend().setVisibleLegendItemsCount(t)}};u.prototype._addNoItemsText=function(t){if(n.isBindingInfo(t)){t&&this._oCalendar.getRows()[0].bindProperty("noAppointmentsText",t)}else{this._oCalendar.getRows()[0].setNoAppointmentsText(t)}};return u});